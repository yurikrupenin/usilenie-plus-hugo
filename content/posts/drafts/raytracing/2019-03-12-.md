---
title: 'Рейтрейсинг в реальном времени, часть 1: что вообще происходит?'
author: Юрий Крупенин
type: post
date: 1970-01-01T00:00:00+00:00
draft: true
url: /?p=194
categories:
  - Шитпостинг

---
Веселей всего после презентации карт серии RTX наблюдать за реакциями работающих с трёхмерной графикой людей и обычных игроков: первые не могут поверить в почти уже дошедший до массового рынка рейтрейсинг и шепчут что-то вроде &#171;неужели мы дожили до этого момента&#187;, вторые &#8212; ворчат об очередном гиммике уровня HairWorks.

Почти как если бы более глубокое понимание технологии позволяло более широко взглянуть на перспективы её применения (я не говорю, что в профессиональной сфере инициативу Nvidia одобряют на сто процентов, но большинство вопросов оттуда относится к деталям имплементации и уровню долгосрочной поддержки новой архитектуры).

Но и игроков понять можно: вот самодовольный твит Nvidia, выпущенный прямо в разгар презентации. Попробуйте понять, не глядя на угол картинки с зелёным шильдиком, какой из вариантов должен быть революционным.<figure class="wp-block-embed-twitter wp-block-embed is-type-rich">

<div class="wp-block-embed__wrapper">
  <div class="embed-twitter">
    <blockquote class="twitter-tweet" data-width="550" data-dnt="true">
      <p lang="en" dir="ltr">
        The impact of RTX Technology in <a href="https://twitter.com/Battlefield?ref_src=twsrc%5Etfw">@Battlefield</a> V is nothing short of phenomenal. <a href="https://twitter.com/hashtag/GraphicsReinvented?src=hash&ref_src=twsrc%5Etfw">#GraphicsReinvented</a> <a href="https://t.co/7nhGBCC8n1">pic.twitter.com/7nhGBCC8n1</a>
      </p>&mdash; NVIDIA GeForce (@NVIDIAGeForce) 
      
      <a href="https://twitter.com/NVIDIAGeForce/status/1031600171241463808?ref_src=twsrc%5Etfw">August 20, 2018</a>
    </blockquote>
  </div>
</div></figure> 

Тем не менее, если на этот раз всё пройдёт успешно, нас действительно ждёт самый масштабный пересмотр парадигмы аппаратно ускоренной трёхмерной графики в видеоиграх с момента&#8230; я не знаю, с момента появления аппаратно ускоренной трёхмерной графики в видеоиграх?

Просто он будет происходить постепенно.

# Рейтрейсинг и растеризация: в чём разница?

Вы же не думали, что мы обойдёмся без этого вступления?

Если перед вами стоит задача имитировать результат какого-то физического процесса, то у вас есть два основных варианта &#8212; провести симуляцию этого процесса и надеяться, что это не слишком сложно, или придумать какую-нибудь технику попроще, приводящую к отдалённо похожим результатам, и надеяться, что никто особенно не доебётся до неточностей.

И растеризация и рейтрейсинг преследуют как финальную цель построение картинки, похожей на то, что мы видим вокруг себя, но рейтрейсинг для этого пытается симулировать взаимодействие лучей света и физических объектов, в то время как растеризация отвергает этот вариант как слишком дотошный и сидит себе перемножает матрицы, трансформируя трёхмерные координаты объектов и наблюдателя в двухмерные координаты проекции объектов на плоскость экрана, находящегося между ними и наблюдателем.

Видеоигры, конечно, используют растеризацию &#8212; получается поганенько, на каждый чих надо что-то делать руками. Прозрачности, теней и отражений, непрямого освещения: всего этого не существует, вместо них &#8212; хаки. Зато быстро.

Не как рейтрейсинг.<figure class="wp-block-image">

<img src="https://i1.wp.com/upload.wikimedia.org/wikipedia/commons/9/95/Ray_Tracing_Illustration_First_Bounce.png?w=723&#038;ssl=1" alt="" data-recalc-dims="1" /></figure> 

Рейтрейсинг &#8212; это миллионы лучей, выпускаемых из глаза наблюдателя в сцену (да, не без хаков и тут; поменять направление лучей, снизив таким образом необходимое для выстраивания сцены их количество &#8212; самый радикальный, but hey, Платон был бы рад), и каждый надо проверить на пересечение с ближайшей поверхностью, а из точки пересечения &#8212; построить по лучу к каждому источнику света в сцене, чтобы понять, освещена ли эта точка (если между ней и источником света встретится ещё какой-то объект &#8212; значит, не очень).

Как понятно из этого описания, рейтрейсинг позволяет строить гораздо более корректное освещение. Как несколько менее понятно (мы ещё вернёмся к этому вопросу), рейтрейсинг потенциально позволяет рендерить гораздо более комплексные сцены &#8212; стоимость каждого кадра определяется в основном не количеством треугольников (как в случае с растеризацией), а разрешением картинки: по одной операции трассировки набора лучей на каждый пиксель.

# Почему сейчас?

Смело применяйте физическое и психологическое насилие по отношению к каждому аналитику, который не имея инсайдов будет вам задвигать какую-то конкретную версию, но мои основные предположения такие:

  1. Закон Мура еле дышит, и замена кучи сложных программируемых ядер (ой, мы упустили такую возможность рассказать о том, как шейдеры изменили всё, а также о том, что теперь у наших растеризующих хаков есть хаки, у которых есть свои хаки) на кучу относительно тупых, решающих только пересечение лучей с треугольниками, но делающих это гораздо более эффективно, несколько поднимет теоретический потолок производительности (в чём бы он ни измерялся; Nvidia обожает измерять всё и во всём) на оставшихся нескольких итерациях классической CMOS-технологии.
  2. Еле дышит AMD, и Nvidia ничего особенно не потеряет, если AMD несколько сократит отставание в эффективности растеризации (напоминаем, что выделенное исключительно под рейтрейсинг железо расходует самый важный ресурс в мире &#8212; площадь чипа &#8212; который иначе был бы отдан под растеризацию).
  3. В Nvidia работают люди, разделяющие мою мечту о рейтрейсинге в реальном времени, но они могут не только сидеть и ныть.
  4. 
  5. Комбинация любых озвученных причин в любых пропорциях.

Строго говоря, это не первая попытка &#8212; пыталась Intel с Larrabee, пыталась Imagination с PowerVR, пытались в разные годы несколько стартапов поменьше со своими специальными чипами, простые любители развлекались и развлекаются с FPGA, но никто не доходил до серийного выпуска потребительского железа, даже в энтузиастском сегменте.

Попытки рейтрейсинга догнать растеризацию варятся в интересном варианте ада: за то время, что рейтрейсинг в какой-то упрощённой форме становится достаточно производительным, чтобы заменить растеризацию, растеризация обрастает достаточным количеством новых хаков, чтобы выглядеть примерно на одном уровне с этой упрощённой форма рейтрейсинга, и работать при этом значительно быстрее. Соотношение ресурсов, вкладываемых индустрией в растеризацию и рейтрейсинг, делает последний идеальной технологией, которая в любой момент времени уже практически за углом, управляемому термоядерному синтезу такое и не снилось. Интересно, что приблизительно с начала применения шейдеров, начиная от попиксельного освещения, и заканчивая всё более распространённым физически корректным шейдингом, растеризация массово обрастает техниками, позаимствованными у рейтрейсинга. В упрощённой форме, в виде хаков, но всё более и более детально имитирующими работу освещения в реальном мире, не прибегая при этом к собственно трассировке лучей.

Количество падающего на поверхность света зависит от её ориентации по отношению к источнику? Здорово, нам не нужно трассировать никакие лучи, просто привяжем&nbsp; уровень освещённости к ориентации, это можно посчитать достаточно быстро для каждого спроецированного пикселя поверхности, получится похуже, конечно, но всё ещё довольно неплохо.&nbsp;_<span style="color:#ffffff;">Я знаю всё про нормалмэппинг и модель Блинна-Фонга, это очевидно экстремально упрощённый вводный полуразвлекательный текст.</span>_

Внешний вид поверхности зависит от её шероховатости на микромасштабах? Say no more, какая ещё трассировка набора лучей для каждого пикселя, мы просто подкрутим размеры и интенсивность бликов в шейдере в соответствии с коэффициентом шероховатости каждого материала. Вот, смотри, у нас металлические и деревянные поверхности выглядят по-разному. Красиво же, одна блестит, другая &#8212; не очень.&nbsp;<span style="color:#ffffff;"><em>См. выше; это же относится и к BRDF. Да, технически вы можете считать типичный проведённый в рамках G-буфера PBR специальной формой рейтрейсинга, примерно с тем же уровнем истинности вы можете заявить и что классические 2.5D-движки отлично рейтрейсят картинку. Я надеюсь, вы довольны собой.</em></span>

# От гибридного рендеринга к полному переходу

Ну и что, собственно, делать, если большая часть поверхностей при растеризации выглядят лучше, чем может обеспечить рейтрейсинг за то же время рендеринга? Можно поступить просто: начать с малого, большую часть сцены растеризовать, а рейтрейсинг использовать только там, где растеризация всё ещё справляется ЗНАЧИТЕЛЬНО хуже, а там посмотрим, как оно пойдёт через пару поколений железа.

Просто и поступили.

С какими поверхностями растеризация справляется хуже всего? С зеркальными. Построить более-менее корректное отражение на плоском зеркале можно, только отрендерив всю сцену ещё раз с находящейся за зеркалом камеры, и натянув на него получившуюся текстуру (или продублировать всю геометрию отражаемой части сцены в спрятанном за зеркалом пространстве, если боль &#8212; вообще ваша единственная любовь в этой жизни). Построить более-менее корректное отражение на сложном трёхмерном объекте при помощи растеризации нельзя никак, даже не пытайтесь. _<span style="color:#ffffff;">Нет, кьюбмэпы не имеют ничего общего с корректными отражениями.</span>_<figure class="wp-block-image">

<img data-attachment-id="201" data-permalink="https://usilenie.plus/?attachment_id=201" data-orig-file="https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/dld5x6hxgae5gpe.jpg?fit=1200%2C675&ssl=1" data-orig-size="1200,675" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="dld5x6hxgae5gpe" data-image-description="" data-medium-file="https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/dld5x6hxgae5gpe.jpg?fit=300%2C169&ssl=1" data-large-file="https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/dld5x6hxgae5gpe.jpg?fit=723%2C407&ssl=1" src="https://i0.wp.com/51.15.244.21/wp-content/uploads/2018/09/dld5x6hxgae5gpe.jpg?w=723" alt="dld5x6hxgae5gpe" class="wp-image-201" srcset="https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/dld5x6hxgae5gpe.jpg?w=1200&ssl=1 1200w, https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/dld5x6hxgae5gpe.jpg?resize=300%2C169&ssl=1 300w, https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/dld5x6hxgae5gpe.jpg?resize=768%2C432&ssl=1 768w, https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/dld5x6hxgae5gpe.jpg?resize=1024%2C576&ssl=1 1024w" sizes="(max-width: 723px) 100vw, 723px" data-recalc-dims="1" /></figure> 

Я знаю, о чём вы думаете: якобы десять работы, видеокарта за тысячу долларов, и&#8230; результаты не выглядят особенно хорошо? Да, я боюсь, первое поколение больших игр, использующих аппаратный рейтрейсинг, вряд ли будет способно шокировать кого-то картинкой. Вспомните восхождение шейдеров: от красивой водички до перехода на попиксельное освещение прошло три-четыре года, в зависимости от того, что вы считаете за поворотные точки.<figure class="wp-block-image alignnone size-full wp-image-202">

<img data-attachment-id="202" data-permalink="https://usilenie.plus/?attachment_id=202" data-orig-file="https://i1.wp.com/usilenie.plus/wp-content/uploads/2018/09/3dmark2001_shot7_big.jpg?fit=1024%2C768&ssl=1" data-orig-size="1024,768" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="3dmark2001_shot7_big" data-image-description="" data-medium-file="https://i1.wp.com/usilenie.plus/wp-content/uploads/2018/09/3dmark2001_shot7_big.jpg?fit=300%2C225&ssl=1" data-large-file="https://i1.wp.com/usilenie.plus/wp-content/uploads/2018/09/3dmark2001_shot7_big.jpg?fit=723%2C542&ssl=1" src="https://i1.wp.com/51.15.244.21/wp-content/uploads/2018/09/3dmark2001_shot7_big.jpg?w=723" alt="3dmark2001_shot7_big" class="wp-image-202" srcset="https://i1.wp.com/usilenie.plus/wp-content/uploads/2018/09/3dmark2001_shot7_big.jpg?w=1024&ssl=1 1024w, https://i1.wp.com/usilenie.plus/wp-content/uploads/2018/09/3dmark2001_shot7_big.jpg?resize=300%2C225&ssl=1 300w, https://i1.wp.com/usilenie.plus/wp-content/uploads/2018/09/3dmark2001_shot7_big.jpg?resize=768%2C576&ssl=1 768w" sizes="(max-width: 723px) 100vw, 723px" data-recalc-dims="1" /><figcaption>3DMark 2001: 2001, как можно догадаться, год, пакет для бенчмаркинга видеокарт рисует красивую водичку.</figcaption></figure> <figure class="wp-block-image alignnone size-full wp-image-203"><img data-attachment-id="203" data-permalink="https://usilenie.plus/?attachment_id=203" data-orig-file="https://i0.wp.com/usilenie.plus/wp-content/uploads/2018/09/5f7dd-gamescrn_morrowind_03-b.jpg?fit=1024%2C768&ssl=1" data-orig-size="1024,768" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="5f7dd-gamescrn_morrowind_03-b" data-image-description="" data-medium-file="https://i0.wp.com/usilenie.plus/wp-content/uploads/2018/09/5f7dd-gamescrn_morrowind_03-b.jpg?fit=300%2C225&ssl=1" data-large-file="https://i0.wp.com/usilenie.plus/wp-content/uploads/2018/09/5f7dd-gamescrn_morrowind_03-b.jpg?fit=723%2C542&ssl=1" src="https://i2.wp.com/51.15.244.21/wp-content/uploads/2018/09/5f7dd-gamescrn_morrowind_03-b.jpg?w=723" alt="5f7dd-gamescrn_morrowind_03-b" class="wp-image-203" srcset="https://i0.wp.com/usilenie.plus/wp-content/uploads/2018/09/5f7dd-gamescrn_morrowind_03-b.jpg?w=1024&ssl=1 1024w, https://i0.wp.com/usilenie.plus/wp-content/uploads/2018/09/5f7dd-gamescrn_morrowind_03-b.jpg?resize=300%2C225&ssl=1 300w, https://i0.wp.com/usilenie.plus/wp-content/uploads/2018/09/5f7dd-gamescrn_morrowind_03-b.jpg?resize=768%2C576&ssl=1 768w" sizes="(max-width: 723px) 100vw, 723px" data-recalc-dims="1" /><figcaption>2002 год, Morrowind: то же самое делает большая коммерческая игра.</figcaption></figure> <figure class="wp-block-image alignnone size-full wp-image-204"><img data-attachment-id="204" data-permalink="https://usilenie.plus/?attachment_id=204" data-orig-file="https://i1.wp.com/usilenie.plus/wp-content/uploads/2018/09/6_1.jpg?fit=1024%2C768&ssl=1" data-orig-size="1024,768" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="6_1" data-image-description="" data-medium-file="https://i1.wp.com/usilenie.plus/wp-content/uploads/2018/09/6_1.jpg?fit=300%2C225&ssl=1" data-large-file="https://i1.wp.com/usilenie.plus/wp-content/uploads/2018/09/6_1.jpg?fit=723%2C542&ssl=1" src="https://i0.wp.com/51.15.244.21/wp-content/uploads/2018/09/6_1.jpg?w=723" alt="6_1" class="wp-image-204" srcset="https://i1.wp.com/usilenie.plus/wp-content/uploads/2018/09/6_1.jpg?w=1024&ssl=1 1024w, https://i1.wp.com/usilenie.plus/wp-content/uploads/2018/09/6_1.jpg?resize=300%2C225&ssl=1 300w, https://i1.wp.com/usilenie.plus/wp-content/uploads/2018/09/6_1.jpg?resize=768%2C576&ssl=1 768w" sizes="(max-width: 723px) 100vw, 723px" data-recalc-dims="1" /><figcaption>2004 год, Painkiller: шейдеры используются для множества вещей, от эффектов постпроцессинга и до частичной симуляции попиксельного освещения</figcaption></figure> <figure class="wp-block-image alignnone size-full wp-image-205"><img data-attachment-id="205" data-permalink="https://usilenie.plus/?attachment_id=205" data-orig-file="https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/doom3_13.jpg?fit=1280%2C1024&ssl=1" data-orig-size="1280,1024" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="doom3_13" data-image-description="" data-medium-file="https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/doom3_13.jpg?fit=300%2C240&ssl=1" data-large-file="https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/doom3_13.jpg?fit=723%2C578&ssl=1" src="https://i0.wp.com/51.15.244.21/wp-content/uploads/2018/09/doom3_13.jpg?w=723" alt="doom3_13" class="wp-image-205" srcset="https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/doom3_13.jpg?w=1280&ssl=1 1280w, https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/doom3_13.jpg?resize=300%2C240&ssl=1 300w, https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/doom3_13.jpg?resize=768%2C614&ssl=1 768w, https://i2.wp.com/usilenie.plus/wp-content/uploads/2018/09/doom3_13.jpg?resize=1024%2C819&ssl=1 1024w" sizes="(max-width: 723px) 100vw, 723px" data-recalc-dims="1" /><figcaption>2004 год, наконец, Doom 3: полностью попиксельное освещение, ради чего всё более-менее и затевалось.</figcaption></figure> 

На иллюстрациях выше, если вы простите мне мой выбор тайтлов, прослеживается примерный путь индустрии за это время. Почему так долго? Даже самых основных причин много:

  * Фундаментальная &#8212; &#171;мы пока не знаем, как и что можно хорошо сделать на этом железе&#187;.
  * Производительность &#8212; железо делает клёвую новую вещь, но пока что делает эту клёвую новую вещь не слишком быстро
  * Вопрос времени и дизайна &#8212; в игры, уже находящиеся в какой-то стадии разработки, втыкать новую модель освещения поздно &#8212; это потребует переработки значительной части арта и, не дай бог, геймдизайна (вспомните фонарик в Doom 3, который было нельзя использовать одновременно с оружием).
  * Вопрос оправданности вложений &#8212; мы точно хотим вливать миллионы в работу с железом, которое есть у десяти процентов потенциальных покупателей?
  * Вы угадали, любая комбинация трёх предыдущих.

Вы, наверное, представляете, и к чему я подвожу:

Переход на рейтрейсинг, вероятно, потребует ещё больше времени &#8212; это гораздо более радикальная смена парадигмы, чем переход на новую модель шейдинга в рамках растеризации. Полный рейтрейсинг нельзя взять и включить, вам нужно написать полностью новый пайплайн рендеринга, переделать редактор сцен, переработать все материалы и весь код для их создания, с которым работают художники, переделать всю работу со светом, переработать все уровни детализации, схему стриминга и отсечения невидимой геометрии, и это только самые очевидные вещи. Переход на рейтрейсинг не оставит камня на камне от систем рендеринга и хорошенько пройдётся по окружениям создания контента.

Самое опасное &#8212; под большим вопросом остаётся поддержка со стороны консолей следующего поколения. Можно как угодно относиться к текущему положению вещей, но требующая серьезных изменений в дизайне и коде игры и при этом работающая только на PC техника рендеринга сейчас не имеет шансов выжить, а GPU для двух из трёх основных производителей консолей делает не Nvidia, а гораздо более спокойно (по крайней мере, публично) относящаяся к рейтрейсингу AMD, и по большому количеству причин, многие из которых заслуживают отдельных текстов, ситуация эта вряд ли изменится в ближайшем времени.

Эта попытка всё ещё может оказаться неудачной, пусть и зашедшей достаточно далеко.