{{ $original := .Page.Resources.GetMatch (printf "*%s*" (.Get "src")) }}
{{ if .Parent }}
  {{ .Scratch.Set "image" ($original.Fill "200x200 center q90") }}
{{ else }}
  {{ .Scratch.Set "image" ($original.Fit "200x200 center q90") }}
{{ end }}
{{ $thumb := .Scratch.Get "image" }}


<!-- count how many times we've called this shortcode; load the css if it's the first time -->
{{- if not ($.Page.Scratch.Get "figurecount") }}<link rel="stylesheet" href="/css/hugo-easy-gallery.css" />{{ end }}
{{- $.Page.Scratch.Add "figurecount" 1 -}}
<div class="box{{ with .Get "caption-position" }} fancy-figure caption-position-{{.}}{{end}}{{ with .Get "caption-effect" }} caption-effect-{{.}}{{end}}" style="max-width:{{ $original.Width }}">
  <figure {{ with .Get "class" }}class="{{.}}"{{ end }} itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    {{ if .Parent }}
    <div class="lazyimg" style="background-image: url('{{ $thumb.RelPermalink }}');" data-src="{{ $original.RelPermalink }}"{{ with .Get "$original.Size" }} data-size="{{.}}"{{ end }}>
      {{ else }}
      <div class="img">
      {{ end }}
      {{ if .Parent }}
      <img itemprop="thumbnail" width="{{ $original.Width }}" src="{{ $thumb.RelPermalink }}" {{ with .Get "alt" | default (.Get "caption") | default $thumb.RelPermalink }}alt="{{.}}"{{ end }}/><!-- <img> hidden if in .gallery -->
      {{ else }}
      <img class="lazyimg" itemprop="thumbnail" width="{{ $original.Width }}" src="{{ $thumb.RelPermalink }}" data-src="{{ $original.RelPermalink }}"{{ with .Get "alt" | default (.Get "caption") | default $thumb.RelPermalink }}alt="{{.}}"{{ end }}/><!-- <img> hidden if in .gallery -->

      {{ end }}
    </div>
    <a href="{{ $original.RelPermalink }}" itemprop="contentUrl" data-size="{{ $original.Width }}x{{ $original.Height }}"></a>
    {{- if or (or (.Get "title") (.Get "caption")) (.Get "attr")}}
      <figcaption>
        {{- with .Get "title" }}<h5>{{.}}</h5>{{ end }}
        {{- if or (.Get "caption") (.Get "attr")}}
          <p>
            <center>
              <font class="image-caption">
                {{- .Get "caption" -}}
                {{- with .Get "attrlink"}}<a href="{{.}}">{{ .Get "attr" }}</a>{{ else }}{{ .Get "attr"}}{{ end -}}
              </font>
            </center>
          </p>
        {{- end }}
      </figcaption>
    {{- end }}
  </figure>
</div>
